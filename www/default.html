<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>zCloud云桌面</title>
    <link rel="Shortcut Icon" href="desktop/images/zCloud.png" type="image/x-icon" />
    <link rel="stylesheet" href="desktop/desktop.css" type="text/css" />
    <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="desktop/desktop.js"></script>
    <script type="text/javascript" src="../js/DBase.js"></script>

    <script src="https://code.highcharts.com.cn/highcharts/highcharts.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts/modules/exporting.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts/modules/boost.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts/themes/sand-signika.js"></script>
    <script src="http://cdn.hcharts.cn/highcharts-plugins/highcharts-zh_CN.js"></script>


    <style>
        #webGL {
            height: calc(100% - 40px);
            width: 100%;
        }
        
        #label {
            position: absolute;
            padding: 10px;
            z-index: 999999;
            background: #00ff00;
            line-height: 1;
            border-radius: 5px;
            display: none;
            pointer-events: none;
        }
        
        .highChart {
            /*透明度 */
            opacity: 0.5;
            /*设置透明度 子元素不继承透明度*/
            margin: 0;
            right: 0px;
            z-index: 100;
            position: absolute;
        }
    </style>
</head>

<body>
    <div id="label"></div>
    <div id="desktopwrap" class="wrap clear">
        <div id="desktop" class="desktop">
            <div id="desktopContent" class="desktopContent clear">
                <!-- <iframe id='webGL' src="webGL.html" style="float: left;"></iframe> -->
            </div>
        </div>
        <div class="task">
            <div id="taskIcon">

            </div>
            <div id="webSocket" class="webSocket"></div>
            <div id="showTime" class="showTime"></div>
            <div id="zCloud" class="zCloud"></div>
        </div>
    </div>
</body>
<script>
    $(document).ready(function() {
        $("#webSocket").css("background-image", "url(./desktop/images/socket_off.png)");


        //用来存储websocket发来的各个通道下D1到D16实时数据
        var socketData = [];
        setInterval(function() {
            var ws = new WebSocket("ws://192.168.8.35"); //申请一个WebSocket对象，参数是服务端地址，同http协议使用http://开头一样，WebSocket协议的url使用ws://开头，另外安全的WebSocket协议使用wss://开头
            ws.onopen = function() {　　 //当WebSocket创建成功时，触发onopen事件
                console.log("socket connected");　　
                $("#webSocket").css("background-image", "url(./desktop/images/socket_on.png)");
            }
            ws.onmessage = function(e) {　　 //当客户端收到服务端发来的消息时，触发onmessage事件，参数e.data包含server传递过来的数据　　
                //console.log(e.data);　
                var strs = e.data.split('|');
                socketData = [];
                for (let i = 2, t = 1, index = 0; i < strs.length;) {
                    let Ddata = parseFloat(strs[i]); //
                    if (Ddata > 0.0) { //说明该通道下有数据
                        i++;
                        let TNum = 'T' + t++;
                        socketData.push({
                            "name": TNum,
                            "data": [],
                        });
                        while (Ddata > 0) {
                            socketData[index]["data"].push(eval(strs[i]));
                            i++;
                            Ddata--;
                        }
                        index++;
                    } else
                        i++;
                }
                //console.log(socketData);
            }
            ws.onclose = function(e) {　　 //当客户端收到服务端发送的关闭连接请求时，触发onclose事件　　
                console.log("socket close");
                socketData = [];
                $("#webSocket").css("background-image", "url(./desktop/images/socket_off.png)");
            }
            ws.onerror = function(e) {　　 //如果出现连接、处理、接收、发送数据失败的时候触发onerror事件　
                console.log("socket error");
                socketData = [];
                $("#webSocket").css("background-image", "url(./desktop/images/socket_error.png)");
            }
        }, 1000);


        var taskIcons = $('#taskIcon');
        var bodyWidth = $(window).width();
        var bodyHeight = $(window).height();
        var desktopContent = $('#desktopContent');

        //创建十三个界面任务栏图标
        var TableCols = ["name", "x", "y", "z", "monitorType", "eng_name"];
        var URL = "/ZcmDB|monitor_site|select * from sites order by x DESC;|";
        var data = window.selectDB(URL, TableCols);
        //console.log(data);
        for (let i in data) {
            let name = data[i]["name"];
            let eng_name = data[i]["eng_name"];

            //动态创建图标，显示在任务栏上
            var childdiv = $('<div></div>');
            childdiv.attr({
                "id": eng_name,
                "name": name,
                "class": 'taskIcon'
            });
            childdiv.css({
                "right": (bodyWidth - 180 - 40 * i),
            });
            taskIcons.append(childdiv);

            //动态创建highChart容器，显示在桌面上
            var highChartDiv = $('<div></div>');
            highChartDiv.attr({
                "id": eng_name + 'Chart',
                "class": 'highChart'
            });

            desktopContent.append(highChartDiv);

            //添加鼠标悬浮事件
            $("#" + eng_name).hover(function(evt) {
                var xPos = evt.pageX || evt.clientX || evt.offsetX || evt.x;
                var yPos = $(window).height() - 80;

                $("#label").css({
                    left: xPos,
                    top: yPos,
                    display: 'block'
                });

                $("#label").html($(this).attr('name'))
            });

            //添加鼠标离开事件
            $("#" + eng_name).mouseleave(function(evt) {
                $("#label").css({
                    display: 'none'
                });
            });

            //添加鼠标点击事件
            $("#" + eng_name).click(function(evt) {
                //该截面所有的通道号
                TableCols = ["ip", "channel"];
                URL = "/ZcmDB|sensor_info|select distinct ip, channel from sensors where monitor_name = '" + eng_name + "' order by channel;|";
                let channelData = window.selectDB(URL, TableCols);
                //console.log(channelData);

                //当前通道号和ip
                let currChannel = channelData[0]["channel"];
                let currIp = channelData[0]["ip"];
                currIp = '192.168.8.35';

                //去ip和channel下查所有传感器前10s的历史数据
                TableCols = ["D1", "D2", "D3", "D4", "D5", "D6", "D7", "D8", "D9", "D10", "D11",
                    "D12", "D13", "D14", "D15", "D16"
                ];
                let lastDate = new Date();
                let firstDate = new Date(lastDate.getTime() - 10 * 1000);
                lastDate = dateFormat("YYYY-mm-dd HH:MM:SS", lastDate);
                firstDate = dateFormat("YYYY-mm-dd HH:MM:SS", firstDate);
                URL = "/ZcmDB|" + currIp + "|select * from T" + currChannel + " where  D0 BETWEEN " + firstDate + " AND " + lastDate + " order by D0;|";
                let historyData = window.selectDB(URL, TableCols);
                historyData = historyData.slice(-20);
                //console.log(historyData);
                //console.log(URL);
                //将数据放入数组中，它为hightchart的初始数据
                var series = [];
                for (let i = 0; i < TableCols.length; i++) {
                    series.push({
                        "name": TableCols[i],
                        "data": [],
                        "visible": false
                    });
                }
                for (let i = 0, k = 0; i < 10; i++, k++) {
                    let currDate = new Date(firstDate).getTime() + i * 1000;
                    if (currDate == historyData[k]) {
                        for (let j = 0; j < TableCols.length; j++) {
                            series[j]["data"].push([currDate, parseFloat(historyData[j])]);
                        }
                    } else {
                        for (let j = 0; j < TableCols.length; j++) {
                            series[j]["data"].push([currDate, 0.0]);
                        }
                    }
                }
                //console.log(series);
                //如果前10s的数据都为0，默认不显示
                for (let i in series) {
                    let arr = series[i]["data"];
                    let flag = false;
                    for (let j in arr)
                        if (arr[j][1] != 0) {
                            flag = true;
                            break;
                        }
                    series[i]["visible"] = flag;
                }



                Highcharts.setOptions({
                    global: {
                        useUTC: false
                    }
                });

                var chart = Highcharts.chart(eng_name + 'Chart', {
                    chart: {
                        type: 'spline',
                        marginRight: 10,
                        events: {
                            load: function() {
                                var series = this.series;
                                setInterval(function() {
                                    //console.log(socketData);
                                    for (let i in socketData) {
                                        let t = parseInt(socketData[i]["name"].substring(1));
                                        if (t == currChannel) {
                                            let data = socketData[i]["data"];
                                            for (let j = 0; j < series.length; j++) {
                                                let y;
                                                if (j < data.length)
                                                    y = data[j];
                                                else
                                                    y = 0;
                                                let x = new Date().getTime();
                                                series[j].addPoint([x, y], true, true);
                                            }
                                        }
                                    }

                                }, 1000);

                            }
                        }
                    },
                    boost: {
                        useGPUTranslations: true
                    },
                    title: {
                        text: name + '-通道' + currChannel + '-实时数据'
                    },
                    subtitle: {
                        useHTML: true,
                        align: 'left',
                        text: '通道编号:    <span id="' + eng_name + 'Radios"></span>'
                    },
                    xAxis: {
                        type: 'datetime',
                        tickInterval: 1000, //单位：毫秒   
                        dateTimeLabelFormats: {
                            day: '%H:%M:%S'
                        },
                    },
                    yAxis: {
                        title: {
                            text: null
                        }
                    },
                    tooltip: {
                        formatter: function() {
                            return '<b>' + this.series.name + '</b><br/>' +
                                Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                Highcharts.numberFormat(this.y, 2);
                        }
                    },
                    series: series,
                });

                //把该截面所有的通道显示在highchart上
                for (let i in channelData) {
                    let channelNum = channelData[i]["channel"];
                    let radio = $("<input type='radio' name='" + eng_name + "Radio' value='" + channelNum + "'/><label for='" + eng_name + "Radio'>" + channelNum + "   </label>");
                    if (i == 0)
                        radio = $("<input type='radio' name='" + eng_name + "Radio' value='" + channelNum + "' checked='true'/><label for='" + eng_name + "Radio'>" + channelNum + "    </label>");
                    $("#" + eng_name + "Radios").append(radio);
                }

                $(".highChart").hide();
                $("#" + eng_name + "Chart").show();
                //console.log($("input[name='" + eng_name + "Radio']:checked").val());

            });
        }


        //让highChartDiv可被鼠标拖拽
        //console.log($(".chartTitle"));
        $("label").click(function() {
            alert('s')
        });
        $(".chartTitle").each(function() {
            var flag = false,
                vHeight, vWidth, cHeight, cWdith;
            $(this).click(function() {
                alert('s')
            });
            // target.mousedown(function(e) {
            //     flag = true;
            //     vHeight = e.pageY;
            //     vWidth = e.pageX;
            //     cHeight = vHeight - $(this).offset().top;
            //     cWdith = vWidth - $(this).offset().left;
            //     //alert("divshow" + $(this).offset().top + " divvHeight" + vHeight);
            //     //alert("高" + cHeight + " 宽" + cWdith);
            // })

            // var showWidth = highChartDiv.width();
            // var showHeight = highChartDiv.height();
            // var documentWidth = $(document).width();
            // var documentHeight = $(document).height();

            // target.mousemove(function(e) {
            //     if (flag) {
            //         var divheight = e.pageY - cHeight; //窗口要移动到的位置
            //         var divwidth = e.pageX - cWdith; //窗口要移动到的位置
            //         //$("#la1").text(divheight + "w" + divwidth + "win" + showWidth + " x " + documentWidth + "" + showWidth);
            //         if (divwidth < 0) {
            //             divwidth = 0;
            //         }
            //         if (divheight < 50) {
            //             divheight = 50;
            //         }
            //         if (divwidth > documentWidth - showWidth) {
            //             divwidth = documentWidth - showWidth - 5;
            //         }
            //         if (divheight > documentHeight - showHeight) {
            //             divheight = documentHeight - showHeight - 5;
            //         }
            //         highChartDiv.css({
            //             "left": divwidth,
            //             "top": divheight
            //         });
            //     }
            // });

            // target.mouseup(function() {
            //     flag = false;
            // });
        });



        //默认打开北部雨棚西侧的监控窗口
        $("#northshackWest").trigger('click');

        function dateFormat(fmt, date) {
            let ret;
            const opt = {
                "Y+": date.getFullYear().toString(), // 年
                "m+": (date.getMonth() + 1).toString(), // 月
                "d+": date.getDate().toString(), // 日
                "H+": date.getHours().toString(), // 时
                "M+": date.getMinutes().toString(), // 分
                "S+": date.getSeconds().toString() // 秒
                    // 有其他格式化字符需求可以继续添加，必须转化成字符串
            };
            for (let k in opt) {
                ret = new RegExp("(" + k + ")").exec(fmt);
                if (ret) {
                    fmt = fmt.replace(ret[1], (ret[1].length == 1) ? (opt[k]) : (opt[k].padStart(ret[1].length, "0")))
                };
            };
            return fmt;
        }
    });
</script>

</html>